# name: CI/CD Deploy on deploy branch

# on:
#   push:
#     branches:
#       - deploy   # DÃ©clenchement uniquement sur la branche deploy

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Setup SSH agent
#         uses: webfactory/ssh-agent@v0.8.1
#         with:
#           ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

#       - name: Sync files to EC2
#         run: |
#           rsync -avz --delete ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/CloudSaaSApp
#         shell: bash

#       - name: SSH and deploy with docker-compose
#         run: |
#           ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
#             cd ~/CloudSaaSApp
#             docker-compose down
#             docker-compose pull
#             docker-compose up -d --build
#           EOF
#         shell: bash



name: Build and Deploy to EC2

on:
  push:
    branches:
      - deploy

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build backend image
        run: |
          docker build -t thisyannhallage/cloudsaasapp-server:latest ./serverWave
          docker push thisyannhallage/cloudsaasapp-server:latest

      - name: Build frontend image
        run: |
          docker build -t thisyannhallage/cloudsaasapp-front:latest ./frontwave
          docker push thisyannhallage/cloudsaasapp-front:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Deploy on EC2
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@${{ secrets.EC2_PUBLIC_IP }} << EOF
            cd /home/ec2-user/CloudSaaSApp
            docker-compose pull
            docker-compose up -d
          EOF
